<!-- =========================
   CREATE / EDIT PRODUCT MODAL
========================= -->
<div id="crudModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-800 bg-opacity-50">
  <div id="crudModalContent" class="bg-white rounded-lg shadow-lg w-5/6 sm:w-3/5 md:w-1/2 lg:w-2/5 xl:w-1/3 max-h-screen overflow-y-auto transition-all transform scale-95 opacity-0 p-6">

    <!-- Modal header -->
    <div class="flex items-center justify-between border-b pb-4 mb-4">
      <div>
        <h3 id="crudModalTitle" class="text-xl font-semibold text-gray-900">Add New Product</h3>
        <p id="crudModalSubtitle" class="text-sm text-gray-600 mt-1">Make your dream product come true!</p>
      </div>
      <button type="button" onclick="hideModal()" class="text-gray-400 hover:bg-gray-200 rounded-lg p-1.5">âœ•</button>
    </div>

    <!-- Modal body -->
    <form id="productForm" enctype="multipart/form-data" class="space-y-4">
      {% csrf_token %}
      <input type="hidden" id="product-id" name="id" />

      <!-- Name -->
      <div>
        <label for="id_name" class="block text-sm font-medium text-gray-700 mb-2">Name</label>
        <input type="text" name="name" id="id_name" class="w-full border rounded-md p-2" placeholder="Product name" required>
      </div>

      <!-- Price -->
      <div>
        <label for="id_price" class="block text-sm font-medium text-gray-700 mb-2">Price</label>
        <input type="number" name="price" id="id_price" class="w-full border rounded-md p-2" placeholder="Price" min="0" required>
      </div>

      <!-- Stock -->
      <div>
        <label for="id_stock" class="block text-sm font-medium text-gray-700 mb-2">Stock</label>
        <input type="number" name="stock" id="id_stock" class="w-full border rounded-md p-2" placeholder="Stock" min="0" required>
      </div>

      <!-- Description -->
      <div>
        <label for="id_description" class="block text-sm font-medium text-gray-700 mb-2">Description</label>
        <textarea name="description" id="id_description" class="w-full border rounded-md p-2" placeholder="Product description" required></textarea>
      </div>

      <!-- Category -->
      <div>
        <label for="id_category" class="block text-sm font-medium text-gray-700 mb-2">Category</label>
        <select name="category" id="id_category" class="w-full border rounded-md p-2" required>
          <option value="">Choose category</option>
          <option value="jersey">Jersey</option>
          <option value="sepatu">Sepatu</option>
          <option value="bola">Bola</option>
          <option value="aksesoris">Aksesoris</option>
          <option value="random">Random</option>
        </select>
      </div>

      <!-- Thumbnail -->
      <div>
        <label for="id_thumbnail" class="block text-sm font-medium text-gray-700 mb-2">Thumbnail URL</label>
        <input type="url" name="thumbnail" id="id_thumbnail" class="w-full border rounded-md p-2" placeholder="Thumbnail URL">
      </div>

      <!-- Brand -->
      <div>
        <label for="id_brand" class="block text-sm font-medium text-gray-700 mb-2">Brand</label>
        <input type="text" name="brand" id="id_brand" class="w-full border rounded-md p-2" placeholder="Brand name">
      </div>

      <!-- Rating -->
      <div>
        <label for="id_rating" class="block text-sm font-medium text-gray-700 mb-2">Rating</label>
        <input type="number" name="rating" id="id_rating" class="w-full border rounded-md p-2" placeholder="Rating" step="0.01" min="0" max="5">
      </div>

      <!-- Featured Checkbox -->
      <div class="flex items-center gap-2">
        <input type="checkbox" name="is_featured" id="id_is_featured" class="h-4 w-4">
        <label for="id_is_featured" class="text-gray-700 text-sm font-medium">Featured?</label>
      </div>

      <!-- Modal footer -->
      <div class="flex flex-col sm:flex-row gap-4 pt-6 border-t border-gray-200">
        <button type="button" onclick="hideModal()" class="order-2 sm:order-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-md font-medium hover:bg-gray-50 text-center">
          Cancel
        </button>
        <button type="submit" id="submitProduct" class="order-1 sm:order-2 flex-1 bg-blue-600 text-white px-6 py-3 rounded-md font-medium hover:bg-blue-700">
          Save
        </button>
      </div>

    </form>
  </div>
</div>


<!-- =========================
   DELETE CONFIRM MODAL
========================= -->
<div id="deleteModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-800 bg-opacity-50">
  <div class="bg-white rounded-lg shadow-lg w-96 p-6">
    <h3 class="text-lg font-semibold text-gray-900">Are you sure?</h3>
    <p class="text-sm text-gray-600 mt-2">This action cannot be undone.</p>
    <div class="mt-6 flex justify-end gap-4">
      <button onclick="hideDeleteModal()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">Cancel</button>
      <button id="confirmDeleteBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Delete</button>
    </div>
  </div>
</div>

<script>
  // ðŸ”¹ CSRF helper
  const csrftoken = document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];

  // ðŸ”¹ Show & Hide Modal
function showModal(isEdit=false, product=null){
  const modal = document.getElementById("crudModal");
  const content = document.getElementById("crudModalContent");
  const form = document.getElementById("productForm");

  if(!isEdit) form.reset();
  document.getElementById("product-id").value = "";

  if(isEdit && product){
    document.getElementById("crudModalTitle").textContent = "Edit Product";
    document.getElementById("crudModalSubtitle").textContent = "Update product info";
    document.getElementById("product-id").value = product.id;

    const fields = {
      "id_name": product.name,
      "id_price": product.price,
      "id_stock": product.stock,
      "id_description": product.description,
      "id_category": product.category,
      "id_thumbnail": product.thumbnail,
      "id_is_featured": product.is_featured
    };
    for(const id in fields){
      const el = document.getElementById(id);
      if(el){
        if(el.type === "checkbox") el.checked = fields[id] === true || fields[id] === "true";
        else el.value = fields[id];
      }
    }
  }

  modal.classList.remove("hidden");
  content.classList.remove("opacity-0","scale-95");
  content.classList.add("opacity-100","scale-100");
}

function hideModal(){
  const modal = document.getElementById("crudModal");
  const content = document.getElementById("crudModalContent");
  content.classList.remove("opacity-100","scale-100");
  content.classList.add("opacity-0","scale-95");
  setTimeout(()=> modal.classList.add("hidden"), 200);
}

  // ðŸ”¹ Delete modal
  let deleteId = null;
  function showDeleteModal(id){ deleteId=id; document.getElementById("deleteModal").classList.remove("hidden"); }
  function hideDeleteModal(){ deleteId=null; document.getElementById("deleteModal").classList.add("hidden"); }

  document.getElementById("confirmDeleteBtn")?.addEventListener("click", async ()=>{
    if(!deleteId) return;
    try{
      const res = await fetch(`/delete-product/${deleteId}/`, {
        method: "POST",
        headers: {"X-Requested-With":"XMLHttpRequest","X-CSRFToken":csrftoken}
      });
      const data = await res.json();
      if(data.success){
        document.getElementById(`product-${deleteId}`)?.remove();
        showToast("Product deleted!","success");
      } else {
        showToast("Failed to delete product","error");
      }
    }catch(err){
      console.error(err);
      showToast("Error deleting product","error");
    }
    hideDeleteModal();
  });

  // ðŸ”¹ AJAX Add/Edit Product
  document.getElementById("productForm")?.addEventListener("submit", async function(e){
    e.preventDefault();
    const formData = new FormData(this);
    const productId = formData.get("id");
    const url = productId ? `/edit-product-ajax/${productId}/` : "{% url 'main:add_product_ajax' %}";

    try{
      const res = await fetch(url,{
        method:"POST",
        body: formData,
        headers: {"X-Requested-With":"XMLHttpRequest","X-CSRFToken":csrftoken}
      });
      const data = await res.json();
      if(data.success){
        if(productId){
          const card = document.getElementById(`product-${productId}`);
          if(card) card.outerHTML = data.html;
        } else {
          document.getElementById("product-list").insertAdjacentHTML("beforeend", data.html);
        }
        hideModal();
        showToast(productId ? "Product updated!" : "Product added!","success");
      } else {
        showToast("Failed! "+(data.error||""),"error");
      }
    }catch(err){
      console.error(err);
      showToast("Error submitting product","error");
    }
  });
</script>
